# Smart multi-stage CI/CD for minimal .NET API
name: Smart Multi-Stage CI/CD

on:
  push: {}

permissions:
  contents: read
  id-token: write

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    outputs:
      dotnet-version: 8.0
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Restore
        run: dotnet restore

      - name: Build (Release)
        run: dotnet build --configuration Release --no-restore

      - name: Show repo variable (SERVICE_NAME)
        run: echo "Built service:${{ vars.SERVICE_NAME }}"

  test:
    name: Test (NUnit)
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Run tests
        run: dotnet test --verbosity normal

  deploy-dev:
    name: Deploy to dev
    needs: test
    runs-on: ubuntu-latest
    environment:
      name: dev
    if: needs.test.result == 'success'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Publish (build publish output)
        run: dotnet publish MyService.Api -c Release -o ./out

      - name: Simulate deploy to dev using published files
        run: |
          echo "Deploying ${{ vars.SERVICE_NAME }} to dev environment"
          echo "Listing published files:"
          ls -la ./out || true
          # Simulate transfer / deploy steps
          echo "Simulating file transfer to dev host..."
          echo "✅ Deployment completed successfully"

  deploy-prod:
    name: Deploy to prod
    needs: test
    runs-on: ubuntu-latest
    # Only run on main branch and when tests succeeded
    if: github.ref == 'refs/heads/main' && needs.test.result == 'success'
    environment:
      name: prod
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Publish (build publish output)
        run: dotnet publish MyService.Api -c Release -o ./out

      - name: Demonstrate secret masking and simulate production deploy
        env:
          PROD_API_KEY: ${{ secrets.PROD_API_KEY }}   # secret stored in prod environment
        run: |
          # Masking explicitly (secrets are automatically masked by Actions, this reinforces it)
          echo "::add-mask::${PROD_API_KEY}"
          echo "Deploying ${{ vars.SERVICE_NAME }} to production environment"
          # The value below will be masked in logs (you will see '***' not the actual secret)
          echo "Using PROD_API_KEY: ${PROD_API_KEY}"
          echo "Listing published files:"
          ls -la ./out || true
          echo "Simulating file transfer to production host..."
          echo "✅ Deployment completed successfully"
