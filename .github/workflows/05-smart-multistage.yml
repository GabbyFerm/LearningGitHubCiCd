# Smart multi-stage CI/CD for minimal .NET API
name: Smart Multi-Stage CI/CD

on:
  push: {}

permissions:
  contents: read
  id-token: write

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    outputs:
      dotnet-version: 8.0
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Restore
        run: dotnet restore

      - name: Build (Release)
        run: dotnet build --configuration Release --no-restore

      - name: Show repo variable (SERVICE_NAME)
        run: echo "Built service:${{ vars.SERVICE_NAME }}"

  test:
    name: Test (NUnit)
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Run tests
        run: dotnet test --verbosity normal

  deploy-dev:
    name: Deploy to dev
    needs: test
    runs-on: ubuntu-latest
    environment:
      name: dev
    if: needs.test.result == 'success'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Publish (build publish output)
        run: dotnet publish ./API/API.csproj -c Release -o ./out

      - name: Simulate deploy to dev using published files
        run: |
          echo "Deploying ${{ vars.SERVICE_NAME }} to dev environment"
          echo "Listing published files:"
          ls -la ./out || true
          # Simulate transfer / deploy steps (scp/rsync/az cli/kubectl)
          echo "Simulating file transfer to dev host..."
          echo "âœ… Deployment completed successfully"

  deploy-prod:
    name: Deploy to prod
    needs: test
    runs-on: ubuntu-latest
    # Only run on main branch and when tests succeeded
    if: github.ref == 'refs/heads/main' && needs.test.result == 'success'
    environment:
      name: prod
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      - name: Publish (build publish output)
        run: dotnet publish ./API/API.csproj -c Release -o ./out

      - name: Demonstrate secret masking and simulate production deploy
        env:
          PROD_API_KEY: ${{ secrets.PROD_API_KEY }}   # secret stored in prod environment
        run: |
          echo "::add-mask::${PROD_API_KEY}"
          echo "Deploying ${{ vars.SERVICE_NAME }} to production environment"
          # The value below will be masked in logs (you will see '***' not the actual secret)
          echo "Using PROD_API_KEY: ${PROD_API_KEY}"
          echo "Listing published files:"
          ls -la ./out || true
          echo "Simulating file transfer to production host..."
          echo "âœ… Deployment completed successfully"
          
  notify-discord:
    name: Notify Discord (build/test result)
    needs: test
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: Mask Discord webhook
      env:
        DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
      run: |
        # ensure webhook secret is masked if printed accidentally
        echo "::add-mask::${DISCORD_WEBHOOK}"

    - name: Success message
      if: ${{ success() }}
      env:
        DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
      run: |
        cat > /tmp/discord_payload.json <<'JSON'
        {
          "username": "PR Bot",
          "avatar_url": "https://www.ditverzinjeniet.nl/wp-content/uploads/2019/01/products-borat-mankini-sfeer.jpg",
          "content": "âœ… Build succeeded!",
          "embeds": [
            {
              "title": "Great success! ðŸŽ‰",
              "image": {
                "url": "https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExcmpwYWJrb242bTczYjB6MnJqeWVhamJ6bXJleW56OHdjOGx2aTh1bSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/Od0QRnzwRBYmDU3eEO/giphy.gif"
              },
              "color": 3066993
            }
          ]
        }
        JSON
                curl -s -H "Content-Type: application/json" -d @/tmp/discord_payload.json "${DISCORD_WEBHOOK}"

    - name: Failure message
      if: ${{ failure() }}
      env:
        DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
      run: |
        cat > /tmp/discord_payload.json <<'JSON'
        {
          "username": "PR Bot",
          "avatar_url": "https://www.ditverzinjeniet.nl/wp-content/uploads/2019/01/products-borat-mankini-sfeer.jpg",
          "content": "âŒ Build failed!",
          "embeds": [
            {
              "title": "NOT great success... ðŸ’€",
              "image": {
                "url": "https://media.giphy.com/media/1BXa2alBjrCXC/giphy.gif"
              },
              "color": 15158332
            }
          ]
        }
        JSON
                curl -s -H "Content-Type: application/json" -d @/tmp/discord_payload.json "${DISCORD_WEBHOOK}"
